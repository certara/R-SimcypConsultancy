#' Get information from an Excel report-input file about a section for a report
#'
#' \code{getSectionInfo} pulls information from an Excel file generated by
#' \code{\link{generateReportInputForm}} to feed into the function
#' \code{\link{pk_table}}. \strong{Most users probably do not want this function
#' alone since it's mainly for use inside other functions.} Please see
#' \code{\link{pk_table}} for details.
#'
#' @param report_input_file the name of the Excel file created by running
#'   \code{\link{generateReportInputForm}}, including the path if it's in any
#'   other directory than the current one, which you have now filled out
#' @param sheet_report the sheet in the Excel report template file that contains
#'   information about this section of the report. In the original template,
#'   this was the tab titled "table and graph input".
#'
#' @return a list object
#' @export
#'
#' @examples
#' # getSectionInfo(report_input_file = "//certara.com/data/sites/SHF/Consult/abc-1a/Report input.xlsx")
#' 
getSectionInfo <- function(report_input_file = NA,
                           sheet_report = "study info - no DDI"){
    
    # Error catching ----------------------------------------------------------
    # Check whether tidyverse is loaded
    if("package:tidyverse" %in% search() == FALSE){
        stop(paste0(wrapn("The SimcypConsultancy R package also requires the package tidyverse to be loaded, and it doesn't appear to be loaded yet. Please run"), "\n     library(tidyverse)\n\nand then try again."), call. = FALSE)
    }
    
    # If they didn't include ".xlsx" at the end, add that.
    report_input_file <- ifelse(str_detect(report_input_file, "xlsx$"), 
                                report_input_file, paste0(report_input_file, ".xlsx"))
    
    
    # Main body of function -------------------------------------------------
    InputXL <- suppressMessages(
        readxl::read_excel(path = report_input_file,
                           sheet = sheet_report, skip = 1)) %>% 
        filter(complete.cases(RName))
    
    sim_data_file <- InputXL$Value[InputXL$RName == "SimFile"]
    
    ## Why did I add the snippet below here??? It's bugging up extractPK, but
    ## I'm not sure whether it's needed!
    # if(dirname(sim_data_file) == "."){
    #     sim_data_file <- paste0(dirname(report_input_file), "/", sim_data_file)
    # }
    
    Deets <- extractExpDetails(sim_data_file = sim_data_file)[["MainDetails"]]
    
    # Checking whether DDI involved.
    DDI <- any(complete.cases(c(Deets$Inhibitor1, Deets$Inhibitor2)))    
    
    if(DDI){
        
        if(any(str_detect(InputXL$Item, "Mean ratios"), na.rm = TRUE) == FALSE){
            stop("You have filled out the report input form tab for a study with no DDI, but Inhibitor 1 and/or Inhibitor 2 are present in your simulation. Please fill out the tab for studies with DDIs.",
                 call. = FALSE)
        }
        
        suppressWarnings(
            ObsData <- InputXL[which(str_detect(InputXL$Item, "^Observed data")):nrow(InputXL),
                               c("RName", "Value")] %>% 
                bind_rows(InputXL[which(str_detect(InputXL$...5, "RNamePerp")):nrow(InputXL), 5:6] %>% 
                              rename(RName = ...5,
                                     Value = ...6) %>% 
                              filter(complete.cases(RName)) %>% 
                              mutate(Value = as.character(Value))) %>% 
                filter(RName != "blank") %>% 
                pivot_wider(names_from = RName, values_from = Value) %>% 
                mutate(across(.cols = -c(ClinStudy, Tissue, MeanType, GMR_mean_type),
                              .fns = as.numeric)) %>% 
                as.list()
        )
        
    } else {
        
        if(any(str_detect(InputXL$Item, "Mean ratios"), na.rm = TRUE)){
            stop("You have filled out the report input form tab for a DDI study, but no perpetrator compounds are present in your simulation. Please fill out the tab for studies with no DDIs.",
                 call. = FALSE)
        }
        
        suppressWarnings(
            ObsData <- InputXL[which(str_detect(InputXL$Item, "^Observed data")):nrow(InputXL), ] %>%
                select(-Item) %>%
                filter(RName != "blank") %>%
                pivot_wider(names_from = RName, values_from = Value) %>% 
                mutate(across(.cols = -c(ClinStudy, Tissue, MeanType), .fns = as.numeric)) %>% 
                as.list()
        )
        
    }
    
    # Tidying up the names used for populations so that they look nice in report
    Population <- tidyPop(Deets$Population)
    NumSimSubj <- Deets[["NumSubjTrial"]] * Deets[["NumTrials"]]
    DoseFreq <- switch(as.character(Deets[["DoseInt_sub"]]),
                       "12" = "BID",
                       "24" = "QD",
                       "8" = "TID",
                       "Single Dose" = "single dose", 
                       "custom dosing" = "custom dosing")
    DoseFreq <- ifelse(is.na(Deets[["DoseInt_sub"]]), "single dose", DoseFreq)
    
    if(DDI){
        
        Deets[["Inhibitor1"]] <- prettify_compound_name(Deets[["Inhibitor1"]])
        Deets[["Inhibitor2"]] <- prettify_compound_name(Deets[["Inhibitor2"]])
        
        if(length(Deets[["DoseInt_inhib"]]) > 0){
            DoseFreq_inhib <- switch(as.character(Deets[["DoseInt_inhib"]]),
                                     "12" = "BID",
                                     "24" = "QD",
                                     "8" = "TID",
                                     "Single Dose" = "single dose", 
                                     "custom dosing" = "custom dosing")
        } else {
            DoseFreq_inhib <- NA
        }
        
        # Days inhibitor was administered
        StartDoseDay_inhib <- as.numeric(sub("Day ", "",
                                             str_split(Deets[["StartDayTime_inhib"]], ", ")[[1]][1]))
        
        LastDoseDay_inhib <-
            (Deets[["DoseInt_inhib"]] * Deets[["NumDoses_inhib"]])/24
        
    } else {
        DoseFreq_inhib <- NA
        StartDoseDay_inhib <- NA
        LastDoseDay_inhib <- NA
    }
    
    # Day substrate was administered
    StartDoseDay_sub <-
        as.numeric(sub("Day ", "",
                       str_split(Deets[["StartDayTime_sub"]], ", ")[[1]][1]))
    
    # Putting everything together
    sectionInfo <- c(Deets, Population,
                     "sim_data_file" = sim_data_file,
                     "NumSimSubj" = NumSimSubj,
                     "DoseFreq" = DoseFreq,
                     "DoseFreq_inhib" = DoseFreq_inhib,
                     "StartDoseDay_sub" = StartDoseDay_sub,
                     "StartDoseDay_inhib" = StartDoseDay_inhib,
                     "LastDoseDay_inhib" = LastDoseDay_inhib)
    
    sectionInfo[["ObsData"]] <- ObsData[sapply(ObsData, complete.cases)]
    
    sectionInfo <- sectionInfo[sort(names(sectionInfo))]
    
    return(sectionInfo)
}
