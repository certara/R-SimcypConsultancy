#' Concentration-time plots of the full time range, first dose, and last dose
#'
#' Conveniently group three concentration-time plots of multiple-dose regimen
#' data together: \enumerate{\item{the full time range across the top,}
#' \item{the first dose in the lower left quadrant, and}  \item{the last dose in
#' the lower right quadrant.}} This uses either \code{\link{ct_plot}} or
#' \code{\link{ct_plot_overlay}} behind the scenes to make the graphs, so most
#' of the options available for those functions will work here.
#'
#' @param ct_dataframe the input concentration-time data generated by running
#'   either the function \code{\link{extractConcTime}} or the function
#'   \code{\link{extractConcTime_mult}}
#' @param overlay TRUE or FALSE for whether to make overlaid graphs, i.e.,
#'   whether to use \code{\link{ct_plot_overlay}} (TRUE) or use
#'   \code{\link{ct_plot}} (FALSE) to generate the graphs
#' @param save_graph optionally save the output graph by supplying a file name
#'   in quotes here, e.g., "My conc time graph.png" or "My conc time
#'   graph.docx". If you leave off ".png" or ".docx" from the file name, it will
#'   be saved as a png file, but if you specify a different graphical file
#'   extension, it will be saved as that file format. Acceptable graphical file
#'   extensions are "eps", "ps", "jpeg", "jpg", "tiff", "png", "bmp", or "svg".
#'   Leaving this as NA means the file will not be saved to disk.
#'   \strong{WARNING:} SAVING TO WORD DOES NOT WORK ON SHAREPOINT. This is a
#'   Microsoft permissions issue, not an R issue. If you try to save on
#'   SharePoint, you will get a warning that R will save your file instead to
#'   your Documents folder. 
#' @param fig_height figure height in inches; default is 6
#' @param fig_width figure width in inches; default is 5
#' @param ... arguments that pass through to \code{\link{ct_plot}} or
#'   \code{\link{ct_plot_overlay}}
#'
#' @return
#' @export
#'
#' @examples
#'
#' data(LMVct)
#' ct_plot3(ct_dataframe = LMVct, linear_or_log = "log")
#'
#' data(MDZ_Keto)
#' ct_plot3(ct_dataframe = MDZ_Keto, overlay = TRUE, colorBy_column = CompoundID)
#' 

ct_plot3 <- function(ct_dataframe, 
                     overlay = FALSE, 
                     figure_type = "means only",
                     mean_type = "arithmetic",
                     linear_or_log = "semi-log", 
                     save_graph = NA,
                     fig_height = 6,
                     fig_width = 5,
                     ...){
    
    # error catching ---------------------------------------------------
    
    # Check whether tidyverse is loaded
    if("package:tidyverse" %in% search() == FALSE){
        stop("The SimcypConsultancy R package also requires the package tidyverse to be loaded, and it doesn't appear to be loaded yet. Please run `library(tidyverse)` and then try again.", 
             call. = FALSE)
    }
    
    if(length(sort(unique(ct_dataframe$DoseNum))) == 1){
        stop("ct_plot3 is only for multiple-dose scenarios, but these data appear to be for only one dose.")
    }
    
    if(hasArg("time_range")){
        stop("You cannot supply anything for 'time_range' here because ct_plot3 needs to set the time range automatically. Please remove 'time_range' from your arguments.")
    }
    
    
    if(nrow(ct_dataframe) == 0){
        stop("Please check your input. The data.frame you supplied for ct_dataframe doesn't have any rows.", 
             call. = FALSE)
    }
    
    # main body of function -------------------------------------------
    
    if(overlay){
        
        A <- ct_plot_overlay(ct_dataframe = ct_dataframe,
                             time_range = NA,
                             figure_type = figure_type,
                             mean_type = mean_type, 
                             linear_or_log = linear_or_log,
                             ..., # comment this for development
                             save_graph = NA) +
            ggtitle("Full time range")
        
        # Suppressing messages and warnings after the 1st set.
        suppressWarnings(suppressMessages(
            B <- ct_plot_overlay(ct_dataframe = ct_dataframe,
                                 time_range = "first dose",
                                 figure_type = figure_type,
                                 mean_type = mean_type, 
                                 linear_or_log = linear_or_log,
                                 ..., # comment this for development
                                 save_graph = NA) +
                ggtitle("First dose")))
        
        suppressWarnings(suppressMessages(
            C <- ct_plot_overlay(ct_dataframe = ct_dataframe,
                                 time_range = "last dose", 
                                 figure_type = figure_type,
                                 mean_type = mean_type, 
                                 linear_or_log = linear_or_log,
                                 ..., # comment this for development
                                 save_graph = NA) +
                ggtitle("Last dose")))
        
        Out <- ggpubr::ggarrange(A, ggpubr::ggarrange(B, C, legend = "none"), 
                                 nrow = 2, common.legend = TRUE, legend = "bottom")
        
    } else {
        
        if(hasArg("colorBy_column") | hasArg("facet1_column") |
           hasArg("facet2_column")){
            stop("It looks like you wanted to use 'ct_plot_overlay' with this function to create graphs of overlaid concentration-time data, but you have specified 'overlay = FALSE' (or left it as the default). Please change 'overlay' to TRUE and try again.")
        }
        
        A <- ct_plot(ct_dataframe = ct_dataframe,
                     figure_type = figure_type,
                     mean_type = mean_type, 
                     linear_or_log = linear_or_log,
                     ..., # comment this for development
                     time_range = NA, 
                     save_graph = NA) +
            ggtitle("Full time range")
        
        suppressWarnings(suppressMessages(
            B <- ct_plot(ct_dataframe = ct_dataframe,
                         figure_type = figure_type,
                         mean_type = mean_type, 
                         linear_or_log = linear_or_log,
                         ..., # comment this for development
                         time_range = "first dose", 
                         save_graph = NA) +
                ggtitle("First dose")))
        
        suppressWarnings(suppressMessages(
            C <- ct_plot(ct_dataframe = ct_dataframe,
                         figure_type = figure_type,
                         mean_type = mean_type, 
                         linear_or_log = linear_or_log,
                         ..., # comment this for development
                         time_range = "last dose", 
                         save_graph = NA) +
                ggtitle("Last dose")))
        
        Out <- ggpubr::ggarrange(A, ggpubr::ggarrange(B, C, legend = "none"), 
                                 nrow = 2, common.legend = TRUE, legend = "bottom")
    }
    
    if(complete.cases(save_graph)){
        FileName <- save_graph
        if(str_detect(FileName, "\\.")){
            # Making sure they've got a good extension
            Ext <- sub("\\.", "", str_extract(FileName, "\\..*"))
            FileName <- sub(paste0(".", Ext), "", FileName)
            Ext <- ifelse(Ext %in% c("eps", "ps", "jpeg", "tiff",
                                     "png", "bmp", "svg", "jpg", "docx"), 
                          Ext, "png")
            FileName <- paste0(FileName, ".", Ext)
        } else {
            FileName <- paste0(FileName, ".png")
            Ext <- "png"
        }
        
        if(Ext == "docx"){
            # This is when they want a Word file as output
            OutPath <- dirname(FileName)
            
            if(OutPath == "."){
                OutPath <- getwd()
            }
            
            # Check for whether they're trying to save on SharePoint, which DOES
            # NOT WORK. If they're trying to save to SharePoint, instead, save
            # to their Documents folder.
            
            # Side regex note: The myriad \ in the "sub" call are necessary b/c
            # \ is an escape character, and often the SharePoint and Large File
            # Store directory paths start with \\\\.
            if(str_detect(sub("\\\\\\\\", "//", OutPath), SimcypDir$SharePtDir)){
                
                OutPath <- paste0("C:/Users/", Sys.info()[["user"]], 
                                  "/Documents")
                warning(paste0("You have attempted to use this function to save a Word file to SharePoint, and Microsoft permissions do not allow this. We will attempt to save the ouptut to your Documents folder, which we think should be ", 
                               OutPath,
                               ". Please copy the output to the folder you originally requested or try saving locally or on the Large File Store."), 
                        call. = FALSE)
            }
            
            LFSPath <- str_detect(sub("\\\\\\\\", "//", OutPath), SimcypDir$LgFileDir)
            
            if(LFSPath){
                # Create a temporary directory in the user's AppData/Local/Temp
                # folder.
                TempDir <- tempdir()
                
                # Upon exiting this function, delete that temporary directory.
                on.exit(unlink(TempDir))
                
            }
            
            FileName <- basename(FileName)
            
            rmarkdown::render(system.file("rmarkdown/templates/multctplot/skeleton/skeleton.Rmd",
                                          package="SimcypConsultancy"), 
                              output_dir = switch(as.character(LFSPath), 
                                                  "TRUE" = TempDir,
                                                  "FALSE" = OutPath),
                              output_file = FileName, 
                              quiet = TRUE)
            # Note: The "system.file" part of the call means "go to where the
            # package is installed, search for the file listed, and return its
            # full path.
            
            if(LFSPath){
                file.copy(file.path(TempDir, FileName), OutPath, overwrite = TRUE)
            }
            
        } else {
            # This is when they want any kind of graphical file format.
            ggsave(FileName, height = fig_height, width = fig_width, dpi = 600, 
                   plot = Out)
            
        }
    }
    
    return(Out)
    
}
