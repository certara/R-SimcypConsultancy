---
title: "DDI report experimental and results sections for one DDI simulation"
author: SimcypConsultancy package version `r packageVersion("SimcypConsultancy")`
date: "Compiled on `r format(Sys.time(), '%B %d, %Y')`"
output: word_document
---

```{r setupResultsSection, echo=FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      dpi = 600, 
                      fig.width = 6, 
                      fig.height = 5)

```

```{r SetupVars2}

MyEffector <- c(exp_details$Inhibitor1, exp_details$Inhibitor1Metabolite, 
                exp_details$Inhibitor2)
MyEffector <- str_comma(MyEffector[complete.cases(MyEffector)])

if(class(prettify_compound_names) == "logical" &&
   # NB: prettify_compound_names is the argument; prettify_compound_name is the function.
   prettify_compound_names){
    
    MySubstrate <- prettify_compound_name(exp_details$Substrate)
    MyEffector <- prettify_compound_name(MyEffector)
    
} else if(class(prettify_compound_names) == "character"){
    
    MySubstrate <- as.character(prettify_compound_names["substrate"])
    MyEffector <- as.character(prettify_compound_names["inhibitor"])
    
} else {
    
    MySubstrate <- exp_details$Substrate
    
}

prettify_compound_names <- c("substrate" = as.character(MySubstrate), 
                             "inhibitor" = as.character(MyEffector))

SDMD_sub_txt <- ifelse(complete.cases(exp_details$DoseInt_sub), 
                       switch(exp_details$DoseRoute_sub, 
                              "Oral" = "multiple oral doses", 
                              "IV" = "multiple IV doses"),
                       switch(exp_details$DoseRoute_sub, 
                              "Oral" = "a single oral dose",
                              "IV" = "a single IV dose"))

DoseFreq_sub <- ifelse(complete.cases(exp_details$DoseInt_sub), 
                       ifelse(exp_details$DoseInt_sub == 12, 
                              "BID", 
                              ifelse(exp_details$DoseInt_sub == 24, "QD", "OTHER REGIMEN")),
                       "")

SDMD_inhib_txt <- ifelse(complete.cases(exp_details$DoseInt_inhib), 
                         switch(exp_details$DoseRoute_inhib, 
                                "Oral" = "multiple oral doses", 
                                "IV" = "multiple IV doses"),
                         switch(exp_details$DoseRoute_inhib, 
                                "Oral" = "a single oral dose",
                                "IV" = "a single IV dose"))
DoseFreq_inhib <- ifelse(complete.cases(exp_details$DoseInt_inhib), 
                         ifelse(exp_details$DoseInt_inhib == 12, 
                                "BID", 
                                ifelse(exp_details$DoseInt_inhib == 24, "QD", "OTHER REGIMEN")),
                         "")

numbers <- c("one", "two", "three", "four", "five", "six", "seven", "eight",
             "nine", "ten", "eleven", "twelve", "thirteen", "fourteen", 
             "fifteen", "sixteen", "seventeen", "eighteen", "nineteen", "twenty")

Numbers <- str_to_title(numbers)

if(complete.cases(exp_details$DoseInt_sub)){
    DoseDay <- "last"
} else {
    
    DoseDay <- str_split_fixed(exp_details$StartDayTime_sub, "Day |, ", 3)[2]
    LastDig <- as.numeric(str_sub(DoseDay, start = -1, end = -1))
    DoseDay <- paste0(DoseDay, ifelse(LastDig %in% c(0, 4:9), 
                                      "th", 
                                      ifelse(LastDig == 1, "st", 
                                             ifelse(LastDig == 2, "nd", "rd"))))
}

DefaultCompound_txt <- ifelse(default_cmpd_file, 
                              paste("The default compound library file for",
                                    ifelse(victim_sim, MyEffector, MySubstrate),
                                    "was used."), "")

```

# METHODS

#### Simulation of `r str_to_title(SDMD_sub_txt)` of `r exp_details$Dose_sub` mg `r str_to_title(MySubstrate)` Administered with `r str_to_title(MyEffector)` in `r tidyPop(exp_details$Population)$PopulationCap` 

`r ifelse(exp_details$NumTrials %in% 1:20, Numbers[exp_details$NumTrials], exp_details$NumTrials)` virtual trials of `r exp_details$NumSubjTrial` `r tidyPop(exp_details$Population)$Population` (`r exp_details$PercFemale*100`% female) aged `r exp_details$Age_min` to `r exp_details$Age_max` years receiving `r SDMD_sub_txt` of `r exp_details$Dose_sub` mg `r MySubstrate` in the absence of `r MyEffector` and on the `r DoseDay` day of `r exp_details$SimDuration/24` days of dosing of `r MyEffector` (`r exp_details$Dose_inhib` mg `r DoseFreq_inhib`) were generated. `r DefaultCompound_txt` Performance verification of the `r ifelse(victim_sim, MyEffector, MySubstrate)` model is provided in Appendix B â€“ Performance Verification of CYP3A Substrates, Inhibitors and Inducers.



# RESULTS

#### Simulation of `r str_to_title(SDMD_sub_txt)` of `r exp_details$Dose_sub` mg `r str_to_title(MySubstrate)` Administered with `r str_to_title(MyEffector)` in `r tidyPop(exp_details$Population)$PopulationCap` 

Mean simulated plasma `r MySubstrate` concentrations following `r SDMD_sub_txt` of `r exp_details$Dose_sub` mg `r MySubstrate` in the absence of `r MyEffector` and on the `r DoseDay` day of `r exp_details$SimDuration/24` days of dosing of `r MyEffector` (`r exp_details$Dose_inhib` mg `r DoseFreq_inhib`) are illustrated in Figure XXX. Simulated plasma concentrations of `r MyEffector` are depicted in Figure XXX. The simulated geometric mean AUC~tau~ and C~max~ values and corresponding GMRs for `r MySubstrate` in the absence and presence of `r MyEffector` are listed in Table XXX.


```{r pullPK}
PKToPull <- PKparameters

Dose1included <- any(str_detect(PKToPull, "_dose1"))
LastDoseincluded <- any(str_detect(PKToPull, "_last"))
Observedincluded <- any(complete.cases(observed_PK))

FigText2 <- ifelse(Dose1included & LastDoseincluded, 
                   ifelse(exp_details$DoseRoute_sub == "Oral", 
                          "the first and multiple oral doses", 
                          paste("the first and multiple", exp_details$DoseRoute_sub, "doses")),
                   ifelse(Dose1included, 
                          ifelse(exp_details$DoseRoute_sub == "Oral", 
                                 "the first oral dose",
                                 paste("the first", exp_details$DoseRoute_sub, "dose")),
                          ifelse(exp_details$DoseRoute_sub == "Oral", 
                                 "multiple oral doses", 
                                 paste("multiple", exp_details$DoseRoute_sub, "doses"))))

FigText3 <- ifelse(any(complete.cases(MyEffector)),
                   paste0("with or without ", MyEffector, " "),
                   "")

MeanTypePK <- ifelse(is.na(mean_type_PK), "geometric", mean_type_PK)

PKsum <- pksummary_table(sim_data_file = paste0(OutPath, "/", sim_data_file), 
                         PKparameters = PKparameters, 
                         mean_type = mean_type_PK, tissue = tissue, 
                         prettify_compound_names = prettify_compound_names)

MyPKResults <- PKsum$Table

```


*Table XXX. Simulated`r ifelse(Observedincluded, " and observed", "")` `r MeanTypePK` mean `r tissue` PK parameters for `r MySubstrate` after `r FigText2` of `r paste(exp_details$Dose_sub, "mg", MySubstrate)` `r FigText3`in `r tidyPop(exp_details$Population)$Population`.*

```{r makeRow1}

data.frame(Col1 = "", 
           Col2 = str_to_title(MySubstrate), Col3 = str_to_title(MySubstrate),
           Col4 = paste(str_to_title(MySubstrate), "plus", str_to_title(MyEffector)),
           Col5 = paste(str_to_title(MySubstrate), "plus", str_to_title(MyEffector)),
           Col6 = "GMR", Col7 = "GMR") %>% 
    flextable::flextable() %>% 
    
    # Make the header bold
    flextable::bold(part = "all") %>%
    
    # center the header row
    flextable::align(align = "center", part = "all") %>% 
    
    # Set the font size
    flextable::fontsize(part = "all", size = 11) %>% 
    
    # Set the font name
    flextable::font(part = "all", fontname = "Arial") %>% 
    
    # setting up which borderlines to show
    # flextable::border_remove() %>% 
    flextable::border_inner_v(part = "all", 
                              border = officer::fp_border(width = 0.5)) %>% 
    
    # making the width autofitted to contents
    flextable::set_table_properties(width = 1, layout = "autofit") %>% 
    flextable::delete_part(part = "header") %>% 
    
    # merging cells
    flextable::merge_h(i = 1) %>% 
    
    # Adding back the border now that header is gone
    flextable::border_outer(border = officer::fp_border(width = 0.5))

```
```{r makeTablePKSummaryOutput}

if("File" %in% names(MyPKResults)){
    MyPKResults <- MyPKResults %>% relocate(File, .after = last_col())
}

formatTable_Simcyp(MyPKResults)

```

```{r captionPKSummary}

CapText1 <- ifelse(any(str_detect(names(MyPKResults), "tmax")), 
                   paste("the", MeanTypePK, "means, except for t~max~, which is median, minimum, and maximum"),
                   paste("the", MeanTypePK, "means"))

CapText2a <- paste0(ifelse(any(str_detect(MyPKResults$Statistic, "CV")),
                           "CV: coefficient of variation; ", ""), 
                    ifelse(any(str_detect(MyPKResults$Statistic, " CI")),
                           "CI: confidence interval; ", ""))

CapText2 <- paste0(sub("; $", ".", CapText2a), 
                   ifelse(Observedincluded, 
                          "S/O: simulated/observed; source observed data: Clinical Study XXX; ",
                          ""))

```

*Simulated values listed are `r CapText1`. `r CapText2` Source simulated data: `r basename(sim_data_file)`* 


```{r ctplotheading}

InhibPresent <- TRUE

Text2 <- ifelse(InhibPresent, 
                paste0("co-administered with ", MyEffector, " "), "")

Text1 <- "Linear (A) and log-linear (B)"
# Text1 <- switch(linear_or_log, 
#                 "both" = "Linear (A) and log-linear (B)",
#                 "both horizontal" ="Linear (A) and log-linear (B)",
#                 "both vertical" = "Linear (A) and log-linear (B)",
#                 "linear" = "Linear", 
#                 "log" = "Log-linear",
#                 "semi-log" = "Log-linear", 
#                 "horizontal and vertical" = "Linear (A) and log-linear (B)")

```

*Figure XXX. `r Text1` simulated `r tissue` concentration-time profiles of `r MySubstrate` `r Text2`in `r tidyPop(exp_details$Population)$Population`.*

```{r ctplot, fig.width = 5, fig.height = 6}

ct_plot(ct_dataframe %>% filter(File == sim_data_file & Tissue == tissue,
                                CompoundID == "substrate"), 
        figure_type = "means only", 
        time_range = time_range,
        y_axis_label = y_axis_label,
        x_axis_interval = x_axis_interval, 
        y_axis_limits_log = y_axis_limits_log, 
        legend_position = "bottom", 
        legend_label = legend_label,
        prettify_compound_names = c("substrate" = MySubstrate, 
                                    "inhibitor" = MyEffector),
        linear_or_log = "both")

```

```{r ctplotCaption}

CapText1 <- paste(
    ifelse(nrow(ct_dataframe %>% filter(Simulated == FALSE)) > 0,
           paste0("and observed (circles; ", mean_type_graph, 
                  " mean of n = ", exp_details$NumTrials * exp_details$NumSubjTrial,
                  " individuals; Clinical Study ", clin_study_name), 
           ""), 
    tissue, "concentration-time profiles of", MySubstrate, 
    "in the absence of", MyEffector, "(solid line)",
    ifelse(complete.cases(exp_details$DoseInt_sub), "and with",
           paste("and on the", DoseDay, "day of")),
    exp_details$SimDuration/24,"days of dosing of", 
    MyEffector, "(dashed line)")

figure_type <- "means only"
CapText2 <- switch(
    figure_type, 
    "trial means" = 
        paste("The grey lines represent",
              mean_type_graph, 
              "mean values of simulated individual trials and the black lines portray the",
              mean_type_graph, 
              "mean data"), 
    "percentiles" = 
        paste("The grey lines represent the 5th and 95th percentiles and the solid black line the",
              mean_type_graph, 
              "mean data"), 
    "percentile ribbon" = 
        paste("The shaded regions represent the 5th to the 95th percentiles and the solid black line the",
              mean_type_graph, "mean data"), 
    "means only" = 
        paste("The solid black line represents the", 
              mean_type_graph, "mean data"), 
    "Freddy" = 
        paste("The grey lines represent", 
              mean_type_graph, 
              "mean values of simulated individual trials and the black lines portray the",
              mean_type_graph, 
              "mean data"))


```

*Depicted are `r CapText1`. `r CapText2` of the simulated population (n = `r exp_details$NumTrials * exp_details$NumSubjTrial`)`r ifelse(figure_type == "Freddy", ". The dashed lines represent the 5th and 95th percentiles", "")`. Source simulated data: `r sim_data_file`.*



*Figure XXX. Simulated `r tissue` concentration-time profiles of `r paste(exp_details$Dose_inhib, "mg", DoseFreq_inhib, MyEffector)` in `r tidyPop(exp_details$Population)$Population`.*


```{r ctplotInhib, fig.width = 5, fig.height = 6}

ct_plot(ct_dataframe %>% filter(File == sim_data_file & Tissue == tissue,
                                CompoundID == "substrate"), 
        figure_type = "means only", 
        time_range = time_range,
        y_axis_label = y_axis_label,
        x_axis_interval = x_axis_interval, 
        y_axis_limits_log = y_axis_limits_log, 
        legend_position = "bottom", 
        legend_label = legend_label,
        prettify_compound_names = c("substrate" = MySubstrate, 
                                    "inhibitor" = MyEffector),
        linear_or_log = "both")

```

*Depicted are simulated `r tissue` concentration-time profiles of `r MyEffector` with administration of `r MySubstrate` on the `r DoseDay` day of `r exp_details$SimDuration/24` days of dosing. The line represents the `r mean_type_graph` mean data for the simulated population (n = `r exp_details$NumTrials * exp_details$NumSubjTrial`) Source simulated data: `r sim_data_file`.





