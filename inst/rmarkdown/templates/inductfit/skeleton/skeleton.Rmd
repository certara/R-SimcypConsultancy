---
title: "Fitted induction data"
author: SimcypConsultancy package version `r packageVersion("SimcypConsultancy")`
date: "Compiled on `r format(Sys.time(), '%B %d, %Y')`"
output: word_document
---

```{r setupindfit, echo=FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      dpi = 600)

```


# Induction models available 

Four induction models (Equations 1, 2, 3, and 4) were fit to the *in vitro* induction data. 

*Equation 1. Ind~max~ model* 

$$ \text{fold induction} = \frac{Ind_{max} \times I}{IndC_{50} + I} $$

*Equation 2. Ind~max~ slope model* 

$$ \text{fold induction} = 1 + Ind_{max} \times \frac{I^n}{IndC_{50}^n + I^n} $$


*Equation 3. Slope model* 

$$ \text{fold induction} = I \times n $$


*Equation 4. Sigmoidal three-parameter model* 

$$ \text{fold induction} = \frac{Ind_{max}}{1 + e^{ \frac{IndC_{50}-[Ind]}{\gamma}}} $$


```{r indFit_ind}

model_label <- switch(model, 
                      "IndmaxSlope" = "Ind~max~ slope model", 
                      "Slope" = "slope model", 
                      "Sig3Param" = "sigmoidal three-parameter model", 
                      "Indmax" = "Ind~max~ model", 
                      "all" = "Ind~max~, Ind~max~ slope, slope, and sigmoidal three-parameter models")


```


*Figure XXX. `r ifelse(model == "all", "Fits", "Fit")` of the `r model_label` to`r ifelse(is.na(enzyme), "", paste0(" ", enzyme))` `r measurement` fold-change data after incubations of human hepatocytes`r ifelse(complete.cases(drug), paste0(" with ", drug, "."), ".")`*

```{r indFit_sum, fig.width = fig_width, fig.height = fig_height}

Out$Graph

FitsThatWorked <- unique(Out$Fit$model)
FitsThatWorked <- paste(str_comma(FitsThatWorked), 
                        ifelse(length(FitsThatWorked) == 1, "model", "models"))
FitsThatWorked <- gsub("Indmax", "Ind~max~", FitsThatWorked)

```


*The models were fit to the `r ifelse(fitByDonor, "individual", "mean")` data, and lines represent successful fits; where fits failed to converge, no line is shown.*

*Table XXX. Fitted parameters for the `r FitsThatWorked` for `r ifelse(is.na(enzyme), "", paste0(" ", enzyme))` `r measurement` fold-change data after incubations of human hepatocytes`r ifelse(complete.cases(drug), paste0(" with ", drug, "."), ".")`*

```{r indfit3}

Fit_ind <- Out$Fit %>% 
    rename(Model = model)

suppressWarnings(
    Fit_sum <- Fit_ind %>% group_by(Model) %>% 
        summarize(across(.cols = everything(), .fns = mean, na.rm = T)) %>% 
        mutate(DonorID = "mean")
)

AllFits <- bind_rows(Fit_ind, Fit_sum) %>% 
    mutate(DonorID = as.factor(DonorID),
           DonorID = forcats::fct_relevel(DonorID, "mean", after = Inf)) %>% 
    arrange(Model, DonorID)

if(complete.cases(num_sigfig)){
        AllFits <- AllFits %>% 
            mutate(across(.cols = any_of(c("Indmax", "IndC50", "slope")), 
                          .fns = signif, digits = num_sigfig))
}

AllFits %>% 
    formatTable_Simcyp(shading_column = Model) %>% 
    flextable::bold(i = which(AllFits$DonorID == "mean")) %>% 
    flextable::merge_v(j = 1) %>% 
    flextable::hline_bottom(border = officer::fp_border(width = 0.5))

```

*`r ifelse(FitsThatWorked == model_label, "", "Only fits that converged are shown in the table.")`*

