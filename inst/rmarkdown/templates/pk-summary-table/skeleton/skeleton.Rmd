---
title: "PK summary table"
author: SimcypConsultancy package version `r packageVersion("SimcypConsultancy")`
date: "Compiled on `r format(Sys.time(), '%B %d, %Y')`"
output: word_document
---

```{r setupPKSummaryOutput, echo=FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      dpi = 600, 
                      fig.width = 6, 
                      fig.height = 5)

```

```{r CalcPKRatiosEqns, echo = FALSE, results = "asis"}

if(FromCalcPKRatios){
   
   highlight_so_cutoffs = NA
   highlight_so_colors = "yellow to red"
   
   if(paired){
      OptionalSection <- knitr::knit_child(
         system.file("rmarkdown/templates/pairedci/skeleton/skeleton.Rmd",
                     package="SimcypConsultancy"), 
         envir = environment(), 
         quiet = TRUE)
      
      cat(OptionalSection, sep = "\n")
      
   } else {
      OptionalSection <- knitr::knit_child(
         system.file("rmarkdown/templates/unpairedci/skeleton/skeleton.Rmd",
                     package="SimcypConsultancy"), 
         envir = environment(), 
         quiet = TRUE)
      
      cat(OptionalSection, sep = "\n")
      
   }
} 

```

```{r FigtextPKSummary}

Annotations <- make_table_annotations(MyPKResults = MyPKResults,
                                      MyFile = sim_data_file, 
                                      PKpulled = PKpulled, 
                                      MyCompoundID = compoundToExtract, 
                                      prettify_compound_names = prettify_compound_names, 
                                      Deets = Deets %>% mutate(File = sim_data_file), 
                                      MeanType = MeanType, 
                                      tissue = tissue)

# Adding a warning if there was a mismatch between the last dosing interval and
# the AUC interval if any of the PK included last dose.
if(CheckDoseInt$message == "mismatch" & any(str_detect(PKpulled, "_last"))){
   DoseIntWarning <- paste0(
      "***The time used for integrating the AUC for the last dose was not the same as the dosing interval. The last dose started at t = ", 
      CheckDoseInt$interval$LastDoseTime, 
      ", and the simulation ended at t = ", 
      CheckDoseInt$interval$SimDuration, 
      ", so the interval for integrating the last-dose AUC was ", 
      CheckDoseInt$interval$IntervalRemaining, 
      " rather than the dosing interval of ", 
      CheckDoseInt$interval$DoseInt_X, ". Please check these results carefully.***")
}

```

`r Annotations[["TableHeading"]]`

`r DoseIntWarning`

```{r makeTablePKSummaryOutput}

if("File" %in% names(MyPKResults)){
   MyPKResults <- MyPKResults %>% relocate(File, .after = last_col())
}

formatTable_Simcyp(MyPKResults, 
                   fontsize = fontsize,
                   prettify_columns = TRUE,
                   highlight_so_cutoffs = highlight_so_cutoffs, 
                   highlight_so_colors = highlight_so_colors, 
                   highlight_gmr_colors = highlight_gmr_colors)

```

`r Annotations[["TableCaption"]]`


