---
title: "Multiple PK summary tables together"
author: SimcypConsultancy package version `r packageVersion("SimcypConsultancy")`
date: "Compiled on `r format(Sys.time(), '%B %d, %Y')`"
output: word_document
---

```{r setupPKSummaryOutput, echo=FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      dpi = 600, 
                      fig.width = 6, 
                      fig.height = 5)

```

```{r FigtextPKSummary}

Observedincluded <- any(str_detect(MyPKResults$Statistic, "S/O"))
MeanType <- ifelse(is.na(mean_type), "geometric", mean_type)

```
```{r CalcPKRatiosEqns, echo = FALSE, results = "asis"}

if(FromCalcPKRatios){
    if(paired){
        OptionalSection <- knitr::knit_child(
            system.file("rmarkdown/templates/pairedci/skeleton/skeleton.Rmd",
                        package="SimcypConsultancy"), 
            envir = environment(), 
            quiet = TRUE)
        
        cat(OptionalSection, sep = "\n")
        
    } else {
        OptionalSection <- knitr::knit_child(
            system.file("rmarkdown/templates/unpairedci/skeleton/skeleton.Rmd",
                        package="SimcypConsultancy"), 
            envir = environment(), 
            quiet = TRUE)
        
        cat(OptionalSection, sep = "\n")
        
    }
   
   # calc_PK_ratios only has a single tissue option for now, so need to set
   # tissues to tissue. Same w/compounds. 
   tissues <- tissue
   MyPKResults$Tissue <- tissue
   compoundsToExtract <- compoundToExtract
   MyPKResults$CompoundID <- compoundToExtract
} 

```

*Table XXX. Simulated`r ifelse(Observedincluded, " and observed", "")` `r MeanType` mean `r str_comma(tissues)` PK parameters.*

```{r makeTablePKSummaryOutput}

if("File" %in% names(MyPKResults)){
    MyPKResults <- MyPKResults %>% 
        select(!File, File)
}

# If they only wanted 1 tissue, don't include a column for that in the table.
# It'll be listed in the text and takes up room needlessly.
if(length(tissues) == 1){
   MyPKResults <- MyPKResults %>% 
      select(!Tissue)
}

# Similarly, if they only wanted 1 compoundID, don't include a column for that
# in the table.
if(length(compoundsToExtract) == 1){
   MyPKResults <- MyPKResults %>% 
      select(!CompoundID)
}

formatTable_Simcyp(MyPKResults, fontsize = fontsize, 
                   shading_column = File)

```

```{r captionPKSummary}

CapText1 <- ifelse(any(str_detect(names(MyPKResults), "tmax")), 
                   paste("the", MeanType, "means, except for t~max~, which is median, minimum, and maximum"),
                   paste("the", MeanType, "means"))

CapText2a <- paste0(ifelse(any(str_detect(MyPKResults$Statistic, "CV")),
                           "CV: coefficient of variation; ", ""), 
                    ifelse(any(str_detect(MyPKResults$Statistic, " CI")),
                           "CI: confidence interval; ", ""))

CapText2 <- paste0(sub("; $", ".", CapText2a), 
                   ifelse(Observedincluded, 
                          "S/O: simulated/observed; source observed data: Clinical Study XXX; ",
                          ""))

AllFiles <- switch(
    as.character(exists("sim_data_file_pairs", inherits = FALSE)), 
    "TRUE" = # from calc_PK_ratios_mult
        str_comma(unique(unlist(str_split(MyPKResults$File, " / ")))),
    
    "FALSE" = # from pksummary_mult
        str_comma(basename(unique(MyPKResults$File))))
        

```

*Simulated values listed are `r CapText1`. `r CapText2` Source simulated data: `r AllFiles`* 




