# `r Heading`

```{r}

# Name of subfolder: pktableindiv

if(FromCalcPKRatios){
   MyFiles <- str_split_1(unique(MyPKResults[[i]]$File), " / ")
} else {
   MyFiles <- unique(MyPKResults[[i]]$File)
}

if("logical" %in% class(existing_exp_details)){
   # This is when existing_exp_details is NA.
   Deets <- data.frame(Inhibitor1 = "UNKNOWN INHIBITOR", 
                       File = MyFiles)
} else {
   Deets <- existing_exp_details$MainDetails %>% filter(File %in% MyFiles)
}

MyPerpetrator <- determine_myperpetrator(Deets = Deets, 
                                         prettify_compound_names = prettify_compound_names)

DosesIncluded <- c("Dose1" = any(str_detect(PKparameters[[i]]$PKparameter, "_dose1")),
                   "Last" = any(str_detect(PKparameters[[i]]$PKparameter, "_last")), 
                   "User" = "Sheet" %in% names(PKparameters[[i]]) &&
                      any(complete.cases(PKparameters[[i]]$Sheet)))
DosesIncluded <- str_c(names(DosesIncluded)[DosesIncluded], collapse = " ")

if(FromCalcPKRatios){
   IndivAnnotations <- 
      list("table_heading" = 
              paste0(
                 "***Table XXX.*** *Simulated ", MeanType, " mean ", 
                 unique(MyPKResults[[i]]$Tissue),  " PK parameters for the file pair ", 
                 str_comma(MyFiles), "*"), 
           
           "table_caption" = 
              paste0("*Simulated values listed are the ", MeanType, 
                     " means. CV: coefficient of variation; CI: confidence interval. Source simulated data: ", 
                     str_comma(MyFiles), "*"))
   
} else {
   
   IndivAnnotations <- make_table_annotations(
      MyPKResults = MyPKResults[[i]] %>% purrr::discard(~all(is.na(.))), 
      MyFile = unique(MyPKResults[[i]]$File), 
      MyCompoundID = unique(MyPKResults[[i]]$CompoundID), 
      prettify_compound_names = prettify_compound_names,
      existing_exp_details = existing_exp_details, 
      mean_type = mean_type, 
      DosesIncluded = case_match(DosesIncluded, 
                                 "Dose1 User" ~ "Dose1 Last", 
                                 "Last User" ~ "Last", 
                                 .default = DosesIncluded), 
      tissue = unique(MyPKResults[[i]]$Tissue), 
      name_clinical_study = name_clinical_study)
   
   IndivAnnotations[["table_heading"]] <- 
      paste0("***Table XXX.*** *", 
             IndivAnnotations[["table_heading"]], "*")
   
   IndivAnnotations[["table_caption"]] <- 
      paste0("*", IndivAnnotations[["table_caption"]], "*")
   
}

```

`r IndivAnnotations[["table_heading"]]`


```{r}

# Adding a warning if there was a mismatch between the dosing interval and the
# AUC interval

DoseIntProb <- CheckDoseInt_list[[i]] %>% 
         filter(IntStartMatch == FALSE | IntEndMatch == FALSE | 
                   IntDurationMatch == FALSE) 
DoseIntProb <- nrow(DoseIntProb) > 0

if(DoseIntProb){
   
   DoseIntWarning <- list(
      "***WARNING: There was a mismatch between the dosing interval and the AUC interval for the following files and compounds:***\n", 
      
      CheckDoseInt_list[[i]] %>% 
         filter(IntStartMatch == FALSE | IntEndMatch == FALSE | IntDurationMatch == FALSE) %>% 
         mutate(
            Problems = paste0(
               case_when(
                  IntStartMatch == FALSE ~ "Start time of AUC interval does not match start time of dose. ", 
                  .default = ""), 
               case_when(
                  IntEndMatch == FALSE ~ "End time of AUC interval does not match end of dosing interval. ", 
                  .default = ""), 
               case_when(
                  IntDurationMatch == FALSE ~ "The duration of the AUC interval does not match the dosing interval. ", 
                  .default = ""))) %>% 
            select(File, Sheet, CompoundID, StartHr, EndHr, IntDuration, DoseInt, Problems) %>% 
         rename("Start AUC interval time (h)" = StartHr, 
                "End AUC interval time (h)" = EndHr, 
                "AUC interval (h)" = IntDuration, 
                "Dosing interval (h)" = DoseInt) %>% 
         flextable::flextable() %>% 
         flextable::width(j = 1:3, width = 1.2) %>% 
         flextable::width(j = 4:7, width = 0.8) %>% 
         flextable::width(j = 8, width = 1.5), 
      
      "***Please check these results carefully.***")
   
} else {
   
   DoseIntWarning <- list(
      c(), c(), c()
   )
}

```

`r DoseIntWarning[[1]]` 

`r DoseIntWarning[[2]]` 

`r DoseIntWarning[[3]]` 


```{r}

include_dose_num <- check_include_dose_num(
   MyPKResults[[i]] %>% ungroup() %>% 
      purrr::discard(~all(is.na(.))), 
   include_dose_num_orig)

if(include_dose_num == FALSE){
   names(MyPKResults[[i]]) <- sub("Dose 1 |Last dose |_dose1|_last", "", names(MyPKResults[[i]]))
}

TempTable <- MyPKResults[[i]] %>% ungroup() %>% 
   purrr::discard(~all(is.na(.))) %>% 
   select(-any_of(c("CompoundID", "Tissue", "File", "Compound")))
names(TempTable) <- sub("perpetrator", MyPerpetrator, names(TempTable))

if(as_label(shading_column) == "<empty>"){
   
   formatTable_Simcyp(TempTable,
                      hlines = "when dataset changes", 
                      merge_shaded_cells = TRUE, 
                      bold_cells = MakeBold, 
                      merge_columns = intersect(
                         names(MyPKResults), 
                         c("File", "Interval", 
                           "Sheet", "Tissue", 
                           "CompoundID", 
                           "Interval numerator simulation", 
                           "Interval denominator simulation")), 
                      fontsize = fontsize,
                      prettify_columns = prettify_columns, 
                      add_header_for_DDI = add_header_for_DDI, 
                      highlight_gmr_colors = highlight_gmr_colors, 
                      highlight_so_cutoffs = highlight_so_cutoffs, 
                      highlight_so_colors = highlight_so_colors)
   
} else {
   
   formatTable_Simcyp(TempTable,
                      shading_column = !!shading_column, 
                      bold_cells = MakeBold, 
                      merge_shaded_cells = TRUE, 
                      merge_columns = intersect(
                         names(MyPKResults), 
                         c("File", "Interval", 
                           "Sheet", "Tissue", 
                           "CompoundID", 
                           "Interval numerator simulation", 
                           "Interval denominator simulation")), 
                      fontsize = fontsize,
                      prettify_columns = prettify_columns, 
                      add_header_for_DDI = add_header_for_DDI, 
                      highlight_gmr_colors = highlight_gmr_colors, 
                      highlight_so_cutoffs = highlight_so_cutoffs, 
                      highlight_so_colors = highlight_so_colors)
   
}

```

`r IndivAnnotations[["table_caption"]]`
